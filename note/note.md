![img.png](assets/img.png)
上面的图片就是钱(货币)的流动的理想图，除了货币，还有债券，拆借等等金融工具在流转
![img_1.png](assets/img_1.png)
资本市场中，流通的是证券

帮助企业上市(也就是发行中介) 投行

委托中介(经纪业务，用户在投资机构 开通账户帮忙投资)
因为个人不能直接和交易所交易 ，必须委托给投资机构
![img_2.png](assets/img_2.png)

![img_3.png](assets/img_3.png)

交易主站1~n通过tcp https ws 连接终端(手机app PC端 Web DNS)

终端把数据推送给交易主站

日志会放在大数据平台

![img_4.png](assets/img_4.png)

有一个专门的线程管理与终端的连接

有终端发数据的话，这个专门的线程把数据交给到专门的业务的线程

权限鉴权就是请求会带有token等身份信息,然后鉴别身份信息

流速是查看请求是否来得及处理

记日志

处理业务

返回响应

![img_5.png](assets/img_5.png)

![img_6.png](assets/img_6.png)
中台和业务是最紧密的
所以中台需要快速的响应和迭代
把中台业务拆成一个个微服务，原子化成各个基础组件
而业务就是各个基础组件的组合
![img_7.png](assets/img_7.png)

![img_8.png](assets/img_8.png)

![img_9.png](assets/img_9.png)
半同步的意思是 主db必须接收到备db的ack之后再进行

TA=transaction agent

这里的核心就是交易系统

![img_10.png](assets/img_10.png)

![img_11.png](assets/img_11.png)

终端可以是 web app等等
柜台就是券商的服务窗口 柜台负责报送委托的模块叫做报盘机
报盘机把顾客的委托先丢给前置网关，排队机把前置网关的数据一批拿走
再按照时间优先，价格优先，量优先，进行排序
在撮合，再把行情数据发布出去

排队机特性:
高可用+低延迟
![img_12.png](assets/img_12.png)

柜台保存顾客所有数据 主要是自己持仓 委托记录 成交记录
券商和商业银行清算中心和登记结算中心 清算股份，最后再和所有的顾客清算股份

eg：一个客户想买平安银行的股票，收到从终端的客户的委托之后，柜台需要判断这是深交所的还是上交所的上市的股票
如果是上交所，就选择 自己和上交所的交易网关的链路 并发送数据

报盘:保存客户的委托，并提供查询功能 ； 与交易所通信，把客户的委托交传递给交易所，接受交易所发送的报价

登录： 先委托终端 再柜台

银证转账：
07年之前

客户资金 从银行卡 -> 券商的账户（客户证券保证金专用账户） -> 银行账户
券商根据客户存入还是取出进行相应的操作
eg:
客户 转了100w => 客户证券保证金专用账户
保证金专用账户 也就是说 可以只要30w 就算符合内外部的监管要求 30w就是保证金
当时很多营业部 对剩余70w进行非法操作， 类似于那客户的钱炒股票
如果70w操作 导致丢失的话，客户想要取钱，就取不到了

现在是三方存款制度
人话就是现在的钱 不是存在券商 而是存在银行， 银行来清算钱
银行清算完之后，在高职给券商，券商只有账本，没有客户资金

发送委托：
一般情况下
委托终端会把委托 发送给柜台 ，柜台写到db的委托表
然后有一个进程以高频来轮训委托表 然后发送给报盘机
但是对磁盘的要求很高，造成计算资源的浪费

新的架构
不需要维护轮询的进程


根据img_40 和前端代码 OrderWidget，当，填入了价格这个数字之后 就会根据你的可用资金算出最大可买的股票数量
A股交易是每一股票 按照 守 来买1 1手 = 100股，美股就是按照 股 来买


根据img_41,在demo中实时委托成交和历史委托成交 是一个个功能


各家机构的报盘机 是需要连到 交易所的撮合系统
为了接入的高效，交易所会暴露指定的接口和格式
为了安全，交易所 会用各种各养的校验来过滤请求


根据img_43
和委托终端 与 柜台 之间的交互有所不同
柜台与网关 是通过tcp
前置网关对于柜台的数据是不做出业务答复，也就是数据是单向的，
为了交易撮合系统而言，把委托送到撮合核心是优先级最高的事情，其他事情都要给该业务让路
为了保证委托的公平和带宽的利用率，各家机构连接柜台和网关的线 是不会做其他事情的
值域数据的改变，委托的变动 下发的行情，交易所会用其他线路 通过总线的方式发送给各家机构
也就是上行和下行的结构
交易所的网关使用热备的方式来实现多活

排队机: 固定的频率从委托网关中收集委托订单 + 排序
网关不主动发送数据给排队机的原因
不同网关的机架和排队机集群的物理距离 是不同的
会存在某些网关比较早的接受柜台的委托，但是与排队机集群的物理距离导致比其他 离排队机集群近的网关 更晚发送委托

所以改成了排队机主动固定频率去拉取委托，然后对某些时间段的委托集中排序

定序的三大原则
时间优先
相同的时间 再价格优先 买入的价格越高优先 ，卖出的价格越低越优先
相同的价格 量优先

排队机 必须高可用,不能一个一个节点挂了，排队机集群就挂了
必须数据一致性，如果撮合核心重启之后，会随机往排队机集群的某一个节点拉取数据，必须保证所有节点的数据一致

对于img_55而言，a =2 b = 5 因为b=10 并没有被大多数节点接受
